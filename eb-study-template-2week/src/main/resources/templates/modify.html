<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body>
<h2>자유게시판 - 수정</h2>
<form>
    <table>
        <input th:type="hidden" name="postId" th:value="${post.getPostId()}">
        <tr>
            <td>카테고리*</td>
            <td>
                <select name="categoryId">
                    <option th:value="${post.getCategoryId()}"
                            th:text="${post.getCategoryName()}">
                    </option>
                    <option th:each="c : ${category}"
                            th:value="${c.getCategoryId()}"
                            th:text="${c.getCategoryName()}"
                            th:if="${!c.getCategoryName().equals(post.getCategoryName())}">
                    </option>
                </select>
            </td>
        </tr>
        <tr>
            <td>등록 일시</td>
            <td>
                <span th:text="${post.getPostCreatedDate()}"></span>
            </td>
        </tr>
        <tr>
            <td>수정 일시</td>
            <td>
                <span th:text="${post.getPostRevisionDate()}"></span>
            </td>
        </tr>
        <tr>
            <td>조회수</td>
            <td>
                <span th:text="${post.getPostViews()}"></span>
            </td>
        </tr>
        <tr>
            <td>작성자*</td>
            <td>
                <input name="postWriter" type="text" th:value="${post.getPostWriter}">
            </td>
        </tr>
        <tr>
            <td>비밀번호</td>
            <td>
                <input name="postPassword" type="password" value="">
            </td>
        </tr>
        <tr>
            <td>제목*</td>
            <td>
                <input name="postTitle" type="text" th:value="${post.getPostTitle()}">
            </td>
        </tr>
        <tr>
            <td>내용</td>
            <td>
                <textarea th:text="${post.getPostContent()}" name="postContent"></textarea>
            </td>
        </tr>
        <tr>
            <td>파일첨부</td>
            <td id="files">
                <div th:each="file : ${post.getFiles()}">
                    <svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 24 24" width="12" height="12"><path d="M7.835,16.17c-.23-.23-.446-.482-.641-.748-.325-.446-.227-1.072,.22-1.397,.446-.325,1.071-.227,1.397,.219,.129,.178,.274,.349,.437,.511,.803,.803,1.87,1.245,3.005,1.245s2.203-.442,3.005-1.245l5.5-5.5c1.657-1.657,1.657-4.354,0-6.011s-4.354-1.657-6.011,0l-1.058,1.058c-.391,.391-1.023,.391-1.414,0s-.391-1.023,0-1.414l1.058-1.058c2.437-2.438,6.402-2.438,8.839,0,2.437,2.437,2.437,6.402,0,8.839l-5.5,5.5c-1.18,1.181-2.75,1.831-4.419,1.831s-3.239-.65-4.418-1.83Zm-1.582,7.83c1.67,0,3.239-.65,4.419-1.831l1.058-1.058c.391-.39,.391-1.023,0-1.414-.39-.391-1.023-.39-1.414,0l-1.059,1.058c-.803,.803-1.87,1.245-3.005,1.245s-2.202-.442-3.005-1.245-1.245-1.87-1.245-3.005,.442-2.203,1.245-3.005l5.5-5.5c.803-.803,1.87-1.245,3.005-1.245s2.203,.442,3.005,1.245c.16,.161,.306,.332,.436,.51,.324,.447,.949,.547,1.397,.221,.447-.325,.546-.95,.221-1.397-.19-.262-.405-.513-.639-.747-1.181-1.182-2.751-1.832-4.42-1.832s-3.239,.65-4.419,1.831L1.834,13.331C.653,14.511,.003,16.081,.003,17.75c0,1.669,.65,3.239,1.831,4.419,1.18,1.181,2.749,1.831,4.419,1.831Z"/></svg>
                    <input th:type="hidden" th:value="${file.getFileId()}">
                    <span th:text="${file.getFileName()}"></span>
                    <button type="button" onclick="fileDown(this)">다운로드</button>
                    <button type="button" onclick="fileDelete(this)">X</button>
                </div>
                <div id="fileUpload">
                    <input th:if="${fileCount} != 3" th:each="i : ${#numbers.sequence(1, (3 - fileCount))}" name="file" type="file">
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <button type="button" onclick="goToPost()">취소</button>
            </td>
            <td>
                <button type="button" onclick="modifyPost()">저장</button>
            </td>
        </tr>
    </table>
</form>
<input name="start_date" th:type="hidden" th:value="${search.getStartDate()}">
<input name="end_date" th:type="hidden" th:value="${search.getEndDate()}">
<input name="category_id" th:type="hidden" th:value="${search.getCategoryId()}">
<input name="search_word" th:type="hidden" th:value="${search.getSearchWord()}">
<input name="page" th:type="hidden" th:value="${search.getPage()}">
<script>
    let deleteList = [];

    const goToPost = () => {
        const postId = document.getElementsByName('postId')[0].value;
        window.location.href = url("view")+"&post_id="+postId;
    }

    const fileDelete = (button) => {
        if(confirm("삭제?")){
            const div = button.parentElement;
            const fileId = div.querySelector('input[type="hidden"]').value;
            deleteList.push(fileId);
            div.remove();
            const fileUpload = document.getElementById('fileUpload');
            const newInput = document.createElement('input');
            newInput.type = "file";
            newInput.name = "file";
            fileUpload.appendChild(newInput);
            alert("삭제완료");
        }
    }

    const modifyPost = () =>{
        if(modifyValid()){
            const form = document.querySelector('form');
            const formData = new FormData(form);

            const postId = document.getElementsByName('postId')[0].value;

            // 배열의 각 요소를 multipart/form-data로 추가
            deleteList.forEach((item) => {
                formData.append("removeFiles", item);
            });

            fetch("/board/free/modify",{
                method : "POST",
                body : formData
            }).then((response) => {
                if(response.status===200){
                    alert("수정 완료");
                    window.location.href = url("view")+"&post_id="+postId;
                    return Promise.reject();
                }else {
                    return response.text();
                }
            }).then(responseText =>{
                if(responseText){
                    alert(responseText);
                }
            });
        }
    }

    const fileDown = (button) =>{
        const fileId = button.parentElement.querySelector('input[type="hidden"]').value;
        window.location.href = "/board/free/view/download?file="+fileId;
    }
</script>
<script th:src="@{/js/urlAndFormUtils.js}"></script>
</body>
</html>